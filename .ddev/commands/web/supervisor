#!/bin/bash

## Description: Manage supervisor processes (uses DDEV's built-in supervisor)
## Usage: supervisor [status|start|stop|restart|tail|logs]
## Example: "ddev supervisor status"
## Example: "ddev supervisor tail"
## Example: "ddev supervisor restart"

PROCESS_NAME="webextradaemons:articles-subscribe"

case "${1:-status}" in
    status)
        supervisorctl status
        ;;
    start)
        if [ -n "$2" ]; then
            supervisorctl start "$2"
        else
            supervisorctl start "$PROCESS_NAME"
        fi
        ;;
    stop)
        if [ -n "$2" ]; then
            supervisorctl stop "$2"
        else
            supervisorctl stop "$PROCESS_NAME"
        fi
        ;;
    restart)
        if [ -n "$2" ]; then
            supervisorctl restart "$2"
        else
            supervisorctl restart "$PROCESS_NAME"
        fi
        ;;
    tail|logs)
        echo "Tailing logs for articles-subscribe (Ctrl+C to exit)..."
        supervisorctl tail -f "$PROCESS_NAME" 2>&1 || {
            echo ""
            echo "Note: If logs haven't been generated yet, try:"
            echo "  ddev logs -s web"
            echo ""
            echo "Or check if the process is receiving messages:"
            echo "  ddev exec redis-cli PUBLISH articles:crime '{\"test\":\"message\"}'"
        }
        ;;
    *)
        echo "Usage: ddev supervisor [status|start|stop|restart|tail|logs]"
        echo ""
        echo "Commands:"
        echo "  status              Show status of all programs"
        echo "  start [program]     Start articles-subscribe (or specify program)"
        echo "  stop [program]      Stop articles-subscribe (or specify program)"
        echo "  restart [program]   Restart articles-subscribe (or specify program)"
        echo "  tail                Tail logs for articles-subscribe"
        echo "  logs                Alias for 'tail'"
        echo ""
        echo "Examples:"
        echo "  ddev supervisor                    # Show status"
        echo "  ddev supervisor restart            # Restart articles-subscribe"
        echo "  ddev supervisor tail               # View live logs"
        echo "  ddev supervisor stop nginx         # Stop a specific service"
        exit 1
        ;;
esac
