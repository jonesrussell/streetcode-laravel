name: deploy

on:
  workflow_run:
    workflows: ['tests']
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 1

      - name: Download Deployer
        run: |
          curl -LO https://deployer.org/deployer.phar
          chmod +x deployer.phar
          sudo mv deployer.phar /usr/local/bin/dep

      - name: Setup SSH
        run: |
          eval "$(ssh-agent -s)"
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV
          if [ -n "$SSH_PRIVATE_KEY_BASE64" ]; then
            echo "Using SSH_PRIVATE_KEY_BASE64"
            echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d | ssh-add -
          else
            echo "Using SSH_PRIVATE_KEY"
            echo "$SSH_PRIVATE_KEY" | ssh-add -
          fi
          if [ -n "$NORTHCLOUD_DEPLOY_KEY" ]; then
            echo "$NORTHCLOUD_DEPLOY_KEY" | ssh-add -
          fi
          echo "Loaded keys:"
          ssh-add -l
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PRIVATE_KEY_BASE64: ${{ secrets.SSH_PRIVATE_KEY_BASE64 }}
          NORTHCLOUD_DEPLOY_KEY: ${{ secrets.NORTHCLOUD_DEPLOY_KEY }}

      - name: Add Host Key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -T 5 -H streetcode.net >> ~/.ssh/known_hosts
          ssh-keyscan -T 5 -H github.com >> ~/.ssh/known_hosts
          cat >> ~/.ssh/config << EOF
          Host streetcode.net
            User deployer
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          ssh -v -o BatchMode=yes deployer@streetcode.net "echo SSH_OK" || true

      - name: Deploy
        env:
          DEPLOY_ENV: production
        run: |
          set -e
          dep deploy streetcode.net -v
